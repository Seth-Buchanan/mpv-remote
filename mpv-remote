#!/usr/bin/python3
import serial.tools.list_ports
import socket
import sys
import keyboard
from time import sleep

isWindows = sys.platform.startswith('win')

ports = serial.tools.list_ports.comports()
serialInst = serial.Serial()

portVar = "/dev/ttyACM0"

serialInst.baudrate = 9600
serialInst.port = portVar
serialInst.open()


def main():
    while True:
        mpvMode()
        # netrwMode()
# TODO: make better file explorer vs mpv detection
# TODO: make windows compatible


def mpvMode():
    MPVCommands = {
        b'E7180586': b'cycle pause',       # enter
        b'BE410586': b'quit',              # .
        b'EA150586': b'seek  5',           # >
        b'E9160586': b'seek -5',           # <
        b'BD420586': b'seek  60',          # ^
        b'BC430586': b'seek -60',          # v
        b'807F0586': b'playlist-next',     # >>|
        b'7F800586': b'playlist-prev',     # |<<
        b'E31C0586': b'cycle sub',         # CCD
        b'E8170586': b'show-progress',     # INFO*
        b'F6090586': b'cycle fullscreen',  # 0
        b'F30C0586': b'add volume  5',     # vol ^
        b'F20D0586': b'add volume -5'      # vol v
    }

    while True:
        if serialInst.in_waiting:
            packet = serialInst.readline().rstrip()
            # rstrip() removes the \r\n off the end of the arduino input

            print(packet)  # returns hex value that the script is comparing
            if packet in MPVCommands.keys():
                command = MPVCommands.get(packet)
                print(command.decode("ascii"))
                doMpvCmd(command)
                if command == b'quit':
                    break
            else:
                print("unbound button")
        sleep(.1)
    netrwMode()  # uncomment if you want to control from netrw
    # TODO: use mpv plugin to browse video files


def netrwMode():
    keyboardKeys = {
        b'E7180586': "`",      # enter
        b'EA150586': "enter",  # >
        b'E9160586': "-",      # <
        b'BD420586': "k",      # ^
        b'BC430586': "j"       # v
    }

    while True:
        if serialInst.in_waiting:
            packet = serialInst.readline().rstrip()
            print(packet)
            if packet in keyboardKeys:
                key = keyboardKeys.get(packet)
                print(key)
                click(key)

                if key == "`":
                    break

        sleep(.1)
    mpvMode()


def click(key):
    keyboard.press(key)
    sleep(.1)
    keyboard.release(key)


def doMpvCmd(thecmd):
    # adds the new line character that effectively enters the command
    try:
        if isWindows:
            f = open(r'\\.\pipe\mpv-pipe', 'wb')
            f.write(thecmd)
            f.write(b'\n')
            f.close()
        else:
            client = socket.socket(socket.AF_UNIX)
            client.connect('/tmp/mpv-socket')
            client.send(thecmd)
            client.send(b'\n')
            client.close()
    except IOError:
        # keeping silent in case mpv is not open
        pass


main()

# portList = []
# for onePort in ports:
#     portList.append(str(onePort))
#
# val = input("select Port: COM")
#
# for i in range(0, len(portList)):
#     if portList[i].startswith("COM" + str(val)):
#         portVar = "COM" + str(val)
#         print(portVar[i])
